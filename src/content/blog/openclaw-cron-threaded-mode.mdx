---
title: Threaded Mode 下定时任务配置教程
description: 详解在 Threaded Mode 话题模式下如何正确配置定时任务，包括权限设置、Thread ID 查询和任务创建。
pubDate: 2026-02-19
updated: 2026-02-19
draft: false
categories:
  - 教程
tags:
  - Openclaw
  - Threaded Mode
  - 定时任务
---

# Threaded Mode 下定时任务配置教程

之前写了两篇关于 Openclaw 任务隔离的文章，有朋友在配置定时任务时遇到问题。详细研究了一下，把过程记录下来。

## 遇到什么问题

在 Threaded Mode 下配置定时任务，默认会收到"沙箱受限无法发送消息"的错误。原因有两个。

沙箱限制是第一个。Openclaw 沙箱默认拒绝 cron 工具权限，这是安全考虑，但在定时任务场景下就成了障碍。

会话隔离是第二个。线程模式的话题属于独立会话，定时任务被路由到主进程，权限不够，自然发不出去。

## 权限配置

这个问题需要修改配置文件才能解决。

找到 ~/.openclaw/openclaw.json，添加或修改以下内容：

```json
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "all",
        "scope": "session",
        "deny": ["browser", "canvas", "nodes", "discord", "gateway"],
        "allow": ["cron", "exec", "bash", "process", "read", "write", "edit", "sessions_list", "sessions_history", "sessions_send", "sessions_spawn"]
      }
    }
  },
  "cron": {
    "enabled": true,
    "maxConcurrentRuns": 2,
    "sessionRetention": "24h"
  }
}
```

改完配置后，重启 Gateway 让配置生效：

```
openclaw gateway restart
```

## 查询话题 Thread ID

在目标话题发一条消息，然后运行：

```bash
cat ~/.openclaw/agents/main/sessions/sessions.json | python3 -c "
import json, sys
data = json.load(sys.stdin)
for key, val in data.items():
    if 'thread' in key:
        origin = val.get('origin', {})
        thread = origin.get('threadId')
        print(f'Thread ID: {thread}')
"
```

输出结果就是你要的 Thread ID。比如 Thread ID: 1114。

## 创建定时任务

命令格式如下：

```
openclaw cron add \
  --cron "Cron表达式" \
  --tz "Asia/Shanghai" \
  --message "任务内容" \
  --channel telegram \
  --to "telegram:用户ID:ThreadID" \
  --name "任务名称" \
  --session isolated
```

几个常用场景：

每小时整点汇报价格到 Thread 1114：

```
openclaw cron add \
  --cron "0 * * * *" \
  --tz "Asia/Shanghai" \
  --message "查询 AVAX 合约当前价格并发送到群聊" \
  --channel telegram \
  --to "telegram:7121476065:1114" \
  --name "AVAX整点汇报" \
  --session isolated
```

每天 6点和20点汇报：

```
openclaw cron add \
  --cron "0 6,20 * * *" \
  --tz "Asia/Shanghai" \
  --message "查询 AVAX 合约过去24小时行情数据" \
  --channel telegram \
  --to "telegram:7121476065:1114" \
  --name "AVAX每日汇报" \
  --session isolated
```

每天晚上8点提醒更新博客（Thread 1079）：

```
openclaw cron add \
  --cron "0 20 * * *" \
  --tz "Asia/Shanghai" \
  --message "提醒更新博客" \
  --channel telegram \
  --to "telegram:7121476065:1079" \
  --name "博客提交提醒" \
  --session isolated
```

## 定时任务管理

查看所有定时任务：

```
openclaw cron list
```

查看任务详情：

```
grep -A10 "任务名称" ~/.openclaw/cron/jobs.json
```

删除定时任务：

```
openclaw cron rm <任务ID>
```

手动运行测试：

```
openclaw cron run <任务ID>
```

## 验证配置

检查话题是否收到消息，看日志：

```
tail -20 /tmp/openclaw/openclaw-*.log | grep "thread:1114"
```

日志里出现 lane=session:agent:main:main:thread:1114 就表示成功发送到对应话题了。

## 常见问题

发不到话题里怎么办？确保用 --session isolated 参数，检查上面权限配置是否正确。

不知道 Thread ID 怎么办？在目标话题发消息后查询 sessions.json，方法前面讲过了。

发送到错误话题怎么办？检查 --to 参数格式是否正确，Thread ID 别写错。

## 进阶配置

按话题单独配置权限：

```json
{
  "agents": {
    "list": {
      "thread:1114": {
        "sandbox": {
          "allow": ["cron"]
        }
      }
    }
  }
}
```

限制沙箱资源：

```json
{
  "agents": {
    "defaults": {
      "sandbox": {
        "docker": {
          "memory": "512m",
          "cpus": 0.5
        }
      }
    }
  }
}
```

按上面步骤配置完，定时任务就能自动发送到对应的 Telegram 话题中了。
