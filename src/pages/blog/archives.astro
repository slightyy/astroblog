---
import BaseCard from "@components/BaseCard.astro";
import { DATE_FORMAT } from "@config";
import BaseLayout from "@layouts/BaseLayout.astro";
import {
  getAllPosts,
  getPostsByYearAndMonth,
  sortPostsByDate,
} from "@utils/blogUtils";
import dayjs from "@utils/dayjs";
import { Icon } from "astro-icon/components";

// 获取所有博客文章
const allPosts = await getAllPosts();

// 按日期排序
const sortedPosts = sortPostsByDate(allPosts);

// 按年份和月份分组
const postsByDate = getPostsByYearAndMonth(sortedPosts);

// 转换为数组并按年份排序（降序）和月份（降序）
const years = Array.from(postsByDate.keys()).sort(
  (a, b) => parseInt(b, 10) - parseInt(a, 10),
);

// 从翻译获取月份名称
const monthNames: Record<string, string> = {
  "01": "1月",
  "02": "2月",
  "03": "3月",
  "04": "4月",
  "05": "5月",
  "06": "6月",
  "07": "7月",
  "08": "8月",
  "09": "9月",
  "10": "10月",
  "11": "11月",
  "12": "12月",
};

const getMonthName = (month: string): string => monthNames[month] || month;

// 统计总文章数
const totalPosts = allPosts.length;
---

<BaseLayout title="归档">
  <BaseCard title="归档">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div class="flex items-center gap-2">
        <Icon name="lucide:archive" class="w-6 h-6 text-accent" />
        <h1 id="h1" class="text-2xl md:text-3xl font-bold">归档</h1>
        <div class="badge badge-accent">{totalPosts} 篇文章</div>
      </div>
      <a href="/blog" class="btn btn-outline btn-sm gap-2">
        <Icon name="lucide:book-open" class="w-4 h-4" />
        <span>返回博客</span>
      </a>
    </div>
    <div class="divider my-2"></div>
    <p class="text-sm opacity-75">按时间查看所有历史文章。</p>
  </BaseCard>
  <BaseCard title="归档">
    <div class="archives-container">
      {
        years.length > 0 ? (
          <div class="archives-timeline">
            {years.map((year) => (
              <div class="timeline-year">
                <div class="year-header">
                  <div class="year-badge">{year}</div>
                </div>

                <div class="year-content">
                  {Array.from(postsByDate.get(year)!.entries())
                    .sort((a, b) => parseInt(b[0], 10) - parseInt(a[0], 10))
                    .map(([month, posts]) => (
                      <div class="timeline-month">
                        <h3 class="month-title">
                          <Icon name="lucide:calendar" class="month-icon" />
                          <span>
                            {getMonthName(month)} {year}
                          </span>
                          <span class="month-count">{posts.length}</span>
                        </h3>

                        <ul class="archive-posts">
                          {posts.map((post) => (
                            <li class="archive-item">
                              <a href={`/blog/${post.slug}`} class="archive-card">
                                <time class="archive-date">{dayjs(post.data.pubDate).format(DATE_FORMAT)}</time>
                                <h4 class="archive-title">{post.data.title}</h4>
                                {post.data.description && <p class="archive-description">{post.data.description}</p>}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <Icon name="ri:emotion-sad-line" class="empty-icon" />
            <p class="empty-text">暂无文章</p>
          </div>
        )
      }
    </div>
  </BaseCard>
</BaseLayout>
